apiVersion: v1
kind: Secret
metadata:
  name: kafka-jaas-config
  namespace: chicmoz-prod
type: Opaque
stringData:
  jaas.conf: |
    KafkaServer {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username="controller_user"
        password="test"
        user_controller_user="test"
        user_inter_broker_user="test"
        user_admin="test";
    };
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: chicmoz-prod
  labels:
    app: kafka
spec:
  serviceName: kafka-headless
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
        - name: kafka
          image: apache/kafka:4.1.1
          ports:
            - containerPort: 9092
              name: client
            - containerPort: 9093
              name: controller
          command:
            - "sh"
            - "-c"
            - |
              # Extract the pod index from the hostname (kafka-0 -> 0)
              export KAFKA_NODE_ID=${HOSTNAME##*-}
              echo "Starting Kafka Node ID: $KAFKA_NODE_ID"

              # Dynamic Advertised Listeners using the specific pod identity
              export KAFKA_ADVERTISED_LISTENERS=SASL_PLAINTEXT://${HOSTNAME}.kafka-headless.chicmoz-prod.svc.cluster.local:9092

              # Start Kafka
              /etc/kafka/docker/run
          env:
            - name: KAFKA_PROCESS_ROLES
              value: "broker,controller"

            # This logic assumes we might scale up to 3 nodes eventually.
            # Only nodes 0, 1, 2 participate in the quorum.
            - name: KAFKA_CONTROLLER_QUORUM_VOTERS
              value: "0@kafka-0.kafka-headless.chicmoz-prod.svc.cluster.local:9093"

            # Listeners
            - name: KAFKA_LISTENERS
              value: "SASL_PLAINTEXT://:9092,CONTROLLER://:9093"
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: "CONTROLLER:PLAINTEXT,SASL_PLAINTEXT:SASL_PLAINTEXT"
            - name: KAFKA_CONTROLLER_LISTENER_NAMES
              value: "CONTROLLER"
            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: "SASL_PLAINTEXT"

            # Auth / SASL
            - name: KAFKA_SASL_ENABLED_MECHANISMS
              value: "PLAIN"
            - name: KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL
              value: "PLAIN"
            - name: KAFKA_OPTS
              value: "-Djava.security.auth.login.config=/etc/kafka/secrets/jaas.conf"

            # Config
            - name: KAFKA_MESSAGE_MAX_BYTES
              value: "10000000"
            - name: KAFKA_LOG_RETENTION_HOURS
              value: "168"
            - name: KAFKA_LOG_RETENTION_BYTES
              value: "1073741824"

            # Single-node & Scalability Safety
            - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
              value: "1"
            - name: KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS
              value: "0"

          volumeMounts:
            - name: data
              mountPath: /var/lib/kafka/data
            - name: jaas-config
              mountPath: /etc/kafka/secrets
          resources:
            limits:
              memory: "1Gi"
              cpu: "500m"
            requests:
              memory: "512Mi"
              cpu: "200m"
      volumes:
        - name: jaas-config
          secret:
            secretName: kafka-jaas-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-headless
  namespace: chicmoz-prod
  labels:
    app: kafka
spec:
  ports:
    - port: 9092
      name: client
    - port: 9093
      name: controller
  clusterIP: None
  selector:
    app: kafka
---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: chicmoz-prod
  labels:
    app: kafka
spec:
  ports:
    - port: 9092
      name: client
      targetPort: client
  selector:
    app: kafka
